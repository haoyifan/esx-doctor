<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>esx-doctor User Manual</title>
  <link rel="icon" type="image/png" href="/icon.png" />
  <style>
    :root {
      --bg: #0f1115;
      --panel: #151923;
      --text: #e6e8ef;
      --muted: #9aa2b2;
      --accent: #5dd6c7;
      --border: #2a3242;
      --font: "Figtree", "Segoe UI", sans-serif;
      --mono: "JetBrains Mono", ui-monospace, monospace;
    }
    body {
      margin: 0;
      padding: 28px;
      font-family: var(--font);
      color: var(--text);
      background: radial-gradient(circle at top left, #1b2130 0%, #0f1115 55%);
      line-height: 1.45;
    }
    .wrap {
      max-width: 960px;
      margin: 0 auto;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 24px;
    }
    h1, h2 { margin: 0 0 10px; }
    h1 { font-size: 28px; }
    h2 { font-size: 18px; margin-top: 24px; }
    p, li { color: var(--muted); }
    code { font-family: var(--mono); color: #d5f7f2; }
    pre {
      margin: 8px 0 0;
      background: #101521;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      overflow: auto;
    }
    .tip {
      border-left: 3px solid var(--accent);
      padding-left: 10px;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>esx-doctor User Manual</h1>
    <p>Interactive viewer for large esxtop/PDH CSV exports.</p>

    <h2>1. Load a CSV</h2>
    <ol>
      <li>Click <code>Choose File</code> in the <code>Dataset</code> section.</li>
      <li>Select a CSV export from your file system.</li>
      <li>Click <code>Open Selected CSV</code>.</li>
      <li>Or paste an HTTP/HTTPS CSV URL and click <code>Open CSV from URL</code>.</li>
    </ol>

    <h2>2. Pick what to graph</h2>
    <ol>
      <li>Choose a report category (<code>All</code>, CPU, Memory, NUMA, Power, Network, Storage, vSAN, Other).</li>
      <li>Reports filter the <code>Attributes</code> list to make selection easier.</li>
      <li>Pick one <code>Attribute</code> (for example <code>Vcpu: % Used</code>).</li>
      <li>Select one or more <code>Instances</code>.</li>
      <li>Click <code>Load</code> to draw the chart.</li>
    </ol>
    <p class="tip">Only one attribute can be graphed at a time, with multiple instances from that attribute. The selected attribute is shown at the top of the right panel.</p>

    <h2>3. Zoom and navigate</h2>
    <ol>
      <li>Drag over the graph to zoom in.</li>
      <li>Double-click the graph to zoom out one level.</li>
      <li>Use <code>Reset Zoom</code> in the chart top bar.</li>
      <li>When zoomed, use the bottom slider to pan the current zoom window across time.</li>
    </ol>

    <h2>3.1 Multi-window analysis</h2>
    <ol>
      <li>Click <code>New Window</code> in the chart header.</li>
      <li>In one window, select <code>Vcpu: % Used</code>.</li>
      <li>In another window, select <code>Vcpu: % Ready</code>.</li>
      <li>Switch between tabs to compare different analyses quickly.</li>
    </ol>

    <h2>4. Filter noisy data (optional)</h2>
    <ol>
      <li>Open <code>Advanced Filter</code> in the left panel.</li>
      <li>Set <code>Min</code> and/or <code>Max</code> values.</li>
      <li>Click <code>Apply Filter</code>.</li>
      <li>An instance stays visible if it has any sample within the selected range.</li>
      <li>Use <code>Reset Filter</code> to clear filter rules.</li>
    </ol>

    <h2>5. Inspect values</h2>
    <ol>
      <li>Hover over the chart to see timestamp and values.</li>
      <li>Values in tooltip are sorted highest to lowest.</li>
      <li>Series labels are compact and focus on instance identity (for example vCPU number/name).</li>
      <li>You can scroll inside the tooltip if many instances are shown.</li>
    </ol>

    <h2>6. Screenshot</h2>
    <ol>
      <li>Click <code>Screenshot</code> in the chart top bar.</li>
      <li>A PNG of the current graph view is downloaded.</li>
    </ol>

    <h2>7. Event Marks (cross-window correlation)</h2>
    <ol>
      <li>Hold <code>Shift</code> and click on the chart to add a mark at the nearest timestamp.</li>
      <li>Marks are shared across windows for the same CSV, so you can compare the same event time in different reports.</li>
      <li>Right-click the chart to open mark actions (<code>Add</code>, <code>Edit</code>, <code>Delete</code>, <code>Clear All</code>).</li>
      <li>Double-click a mark to edit <code>Title</code> and <code>Comment</code>.</li>
      <li>Change mark color from the right-click mark menu.</li>
      <li>Mark comments are hidden by default and shown when hovering a mark.</li>
    </ol>

    <h2>8. Diagnostics</h2>
    <ol>
      <li>Open <code>Diagnostics</code> in the left panel.</li>
      <li>Select one or more templates and click <code>Run Diagnostics</code>.</li>
      <li>Review findings and click <code>Open</code> to jump to the related report/attribute/time range.</li>
      <li>Use diagnostics as guidance, then validate with detailed charts and instance drill-down.</li>
      <li>Click <code>Manage Templates</code> to open the template manager UI.</li>
    </ol>

    <h2>8.0 Template Manager workflow</h2>
    <ol>
      <li>Open <code>Manage Templates</code>.</li>
      <li>Create or edit custom templates with a form (no hand-editing JSON required).</li>
      <li>Use filter conditions with <code>AND</code>/<code>OR</code> logic.</li>
      <li>Select a pattern type:
        sustained threshold, zig-zag switch, or dominance imbalance.</li>
      <li>Save and run diagnostics from the main page.</li>
      <li>Use <code>Import JSON</code> / <code>Export JSON</code> to share templates.</li>
    </ol>

    <h2>8.1 Template format</h2>
    <p>Templates are JSON files in <code>cmd/esx-doctor/templates</code>. Each file defines one detector rule.</p>
    <pre><code>{
  "id": "cpu.high_ready.v1",
  "name": "High Ready Time",
  "description": "Detect sustained vCPU ready time above threshold.",
  "enabled": true,
  "severity": "high",
  "detector": {
    "type": "high_ready",
    "threshold": 5.0,
    "min_consecutive": 6,
    "include_attribute_equals": ["Vcpu: % Ready"],
    "exclude_instance_regex": ["\\bidle\\d+\\b"]
  }
}</code></pre>

    <h2>8.2 Template fields</h2>
    <ul>
      <li><code>id</code>: Unique template ID used by API/UI.</li>
      <li><code>name</code>: Display name shown in template list and findings.</li>
      <li><code>description</code>: Short explanation of what the detector looks for.</li>
      <li><code>enabled</code>: Whether it is enabled by default in the UI.</li>
      <li><code>severity</code>: Finding priority label (for example <code>critical</code>, <code>high</code>, <code>medium</code>, <code>low</code>).</li>
      <li><code>detector.type</code>: Detector engine type (examples below).</li>
    </ul>

    <h2>8.3 Detector fields</h2>
    <ul>
      <li><code>threshold</code>: Numeric threshold for high/low threshold detectors.</li>
      <li><code>comparison</code>: Optional. Use <code>"less"</code> for low-side checks; default is greater-than.</li>
      <li><code>min_consecutive</code>: Minimum consecutive samples required before reporting.</li>
      <li><code>min_switches</code>: For zig-zag pattern detectors (minimum node dominance switches).</li>
      <li><code>min_gap</code>: Minimum value gap required between compared entities.</li>
      <li><code>high_threshold</code> / <code>low_threshold</code>: For imbalance detectors that require high-vs-low criteria.</li>
      <li><code>include_attribute_equals</code>: Exact attribute labels allowed (for example <code>"Vcpu: % CoStop"</code>).</li>
      <li><code>include_object_equals</code>: Exact esxtop object names allowed (for example <code>"Physical Disk Adapter"</code>).</li>
      <li><code>exclude_instance_contains</code>: Exclude instances containing any listed substring.</li>
      <li><code>exclude_instance_regex</code>: Exclude instances matching any listed regex.</li>
    </ul>

    <h2>8.4 Supported detector types</h2>
    <ul>
      <li><code>high_ready</code>: sustained high ready time.</li>
      <li><code>high_costop</code>: sustained high co-stop time.</li>
      <li><code>exclusive_affinity</code>: detects entities with exclusive affinity enabled.</li>
      <li><code>numa_zigzag</code>: aggressive NUMA load dominance switching.</li>
      <li><code>low_numa_local</code>: sustained low local NUMA memory.</li>
      <li><code>memory_overcommit_high</code>: sustained high memory overcommit.</li>
      <li><code>numa_imbalance</code>: one NUMA node persistently high while another remains low.</li>
      <li><code>network_outbound_drop_high</code>: sustained high outbound packet drops.</li>
      <li><code>disk_adapter_failed_reads_high</code>: sustained adapter failed reads.</li>
      <li><code>disk_adapter_driver_latency_high</code>: sustained high adapter driver latency.</li>
    </ul>

    <h2>9. Optional settings and help</h2>
    <ol>
      <li><code>Appearance</code> and <code>Advanced Filter</code> are collapsed by default.</li>
      <li>Use <code>?</code> icons across sections to see quick hover help.</li>
    </ol>

    <h2>Troubleshooting</h2>
    <ul>
      <li>If no lines appear, verify you selected at least one instance and clicked <code>Load</code>.</li>
      <li>If timeline seems short, confirm your CSV actually spans that time range.</li>
      <li>If values look unusual, hover tooltip to inspect exact instance values.</li>
    </ul>
  </div>
</body>
</html>
